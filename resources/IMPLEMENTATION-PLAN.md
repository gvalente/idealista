### Deliverable: Functional Specification & Implementation Plan

Product Name: Idealista Trust Shield (v1.0 MVP)

Document Version: 2.1 (Final)

Date: August 3, 2025

Author: AI Engineering Partner

Reviewer: AI Peer Engineer

* * * * *

#### 1\. Introduction & Purpose

This document outlines the functional requirements and technical implementation strategy for the "Idealista Trust Shield" Chrome extension MVP. It serves as the engineering blueprint that bridges the strategic vision defined in the Verbose Product One-Pager and the visual design finalized in v10 from our AI UI generator.

The primary goal of this document is to provide a clear, unambiguous roadmap for development, address key technical challenges upfront, and define the success criteria for a functional, performant, and user-centric product.

* * * * *

#### 2\. Scope of Work (MVP v1.0)

##### 2.1 In-Scope Features

The MVP will deliver the following core functionalities as defined in our user stories:

-   Real-time Analysis: The extension will run automatically on Idealista search results and individual listing pages.

-   UI Overlay: The extension will inject the v10 UI components (pills on search page, collapsed/expanded views on listing page) onto the host website without disrupting the native user experience.

-   Trust & Quality Scoring: The extension will calculate a consolidated score based on:

-   Scam Keyword Detection

-   Price Anomaly Detection

-   Listing Quality Analysis (photo count, floor plan, description length)

-   Listing Freshness

-   Duplicate Listing Detection

-   Advertiser Professionalism Check

-   Responsive Design: The UI will be fully responsive, with a dedicated "bottom sheet" modal for mobile web viewports.

-   Local Caching: The extension will cache calculated scores to improve performance and user experience on subsequent page loads.

##### 2.2 Out-of-Scope Features

To ensure we can deliver a high-quality MVP within our 12-hour sprint, the following will be explicitly excluded from v1.0:

-   User Accounts & Settings: There will be no user login, settings panel, or customization options.

-   Backend Server/Database: The extension will be 100% client-side. It will not collect or transmit any user data to a remote server.

-   Support for Other Portals: The MVP will be built exclusively for idealista.com.

-   Advanced Image Analysis: While we will check for duplicate images based on URL similarity, we will not implement complex computer vision for reverse image searching in the MVP.

* * * * *

#### 3\. High-Level Architecture

The Idealista Trust Shield will be a Manifest V3 Chrome Extension. This architecture is chosen for its security, performance, and ability to directly augment the user's browsing experience.

The core components will be:

-   manifest.json: The configuration file that defines the extension's permissions, icons, and scripts. It will request permissions for activeTab, scripting, and storage.

-   Content Script (content.js): The primary JavaScript file that will be injected into Idealista pages. This script will be responsible for:

-   Initial DOM scraping to extract listing IDs.

-   Communicating with the background script to request full data for each listing.

-   Injecting the v10 UI (React components) into the page.

-   Managing the state of the UI (loading, collapsed, expanded).

-   Background Script (service-worker.js): A service worker that runs in the background. Its primary responsibilities will be:

-   Handling all network requests (fetching the /datalayer JSON).

-   Executing the scoring algorithm.

-   Managing the local cache (chrome.storage.local).

-   Passing the final score and analysis data back to the content script.

-   Scoped CSS (styles.css): A self-contained stylesheet, as generated by v0, that will be scoped to a unique parent container ID to prevent any style conflicts with Idealista's native CSS.

* * * * *

#### 4\. Core Logic & Implementation Strategy

##### 4.1 Data Model

The content script will parse and fetch data into a consistent ListingData object structure for each property. This object will be passed to the scoring algorithm and used to populate the UI.

JavaScript

// Example Structure

const ListingData = {

  id: '106019121',

  url: 'https://www.idealista.com/en/inmueble/106019121/',

  fullDescription: 'SEASONAL RENTAL - FURNISHED AND EQUIPPED...',

  price: 1500,

  size: 60,

  neighborhood: 'El Camp d\'En Grassot i Gràcia Nova',

  photoCount: 20,

  hasFloorPlan: false, // Determined by presence of 'icon-plan'

  lastUpdated: '2025-08-03T12:00:00Z',

  advertiserType: 'agency', // 'agency' or 'private'

  advertiserName: 'Walter Haus Barcelona',

  contactEmail: null  // To be checked for generic domains

};

##### 4.2 Scoring Algorithm

A weighted algorithm will be implemented in the background script. The score will be a sum of points, normalized to a 0-100 scale. These weights are initial estimates and must be tuned during testing.

-   Base Score = 100

-   Deductions (High Impact):

-   Scam Keywords Detected: -40 points

-   Price Anomaly Detected: -30 points

-   Additions/Deductions (Medium Impact):

-   Has Floor Plan: +10 points / No Floor Plan: -10 points

-   Photo Count (>20): +10 points / Photo Count (<5): -15 points

-   Listing Freshness (<7 days): +5 points / Listing Freshness (>30 days): -10 points

-   Deductions (Low Impact):

-   Potential Duplicate Found: -15 points

-   Agency with Generic Email: -5 points

##### 4.3 Search Page Performance Strategy & Data Retrieval

This is the most critical technical challenge. The goal is to provide a full, accurate score for every listing on the search results page without degrading performance.

Primary Strategy: API-like Data Retrieval via JSON Endpoint

1.  Initial DOM Scan: On a search results page, the content script will perform a single, lightweight scan to extract the unique data-element-id (the adId) for each listing.

2.  Concurrent Data Fetching: For each adId, the content script will send a message to the background script (service-worker.js). The background script will then make an asynchronous fetch request to the structured data endpoint: https://www.idealista.com/detail/{adId}/datalayer. These requests will be managed concurrently.

3.  Full Scoring & Caching: As each JSON response is received in the background, the full scoring algorithm will be run. The complete score and its breakdown will be saved to local storage (chrome.storage.local) using the listing's URL as the key.

4.  UI Updates: The background script will send the final, accurate score back to the content script, which will then update the corresponding UI pill from the "Loading State" to its final state. This ensures score consistency between the search and listing pages.

Contingency Plan

-   Strategy: If the /datalayer endpoint fails (e.g., returns a 403 or 404 error), the background script will automatically revert to fetching the full HTML for the listing's URL.

-   Performance Safeguards: To prevent overwhelming the browser or Idealista's servers, these HTML fetch requests will be managed by a queue with a throttle (e.g., a 200ms delay between each request). The queue will prioritize fetching data for listings currently in the user's viewport.

-   Parsing: The fetched HTML text will be parsed using DOMParser in the background script to create a queryable DOM object without affecting the main page.

* * * * *

#### 5\. UI Implementation

We will use the React/JSX and CSS code exported from v0 as the foundational template for our UI.

-   Refactoring: The v0 code will be reviewed and refactored as necessary to ensure it is performant, componentized logically, and adheres to accessibility best practices.

-   Injection: The content script will create a root DOM element on the Idealista page and use React's createRoot to render our main application component into it.

-   State Management: The content script will manage the UI state, listening for messages from the background script containing the calculated scores and updating the React components with new props.

* * * * *

#### 6\. Error Handling & Edge Cases

The extension must fail gracefully.

-   Network Errors: If a fetch request fails, the UI for that listing will display an "Error" state (e.g., a grayed-out pill with a '?' icon) rather than getting stuck in a loading state.

-   Scraping Failures: If Idealista updates its HTML structure and our DOM selectors fail, the script will catch the error and display the "Error" state for the affected listings.

-   Missing Data: The scoring algorithm will be written to handle null or undefined values for any data point (e.g., a listing with no description or price) and score accordingly without crashing.

* * * * *

#### 7\. Dependencies, Risks, and Mitigation

-   Primary Dependency: The extension is entirely dependent on the HTML structure and internal data endpoints of idealista.com.

-   Risk: Idealista could change its front-end code, breaking our DOM selectors or the /datalayer endpoint.

-   Mitigation: The code will be well-documented with clear comments on the selectors used. The contingency plan for data fetching provides a fallback. The extension's store listing will clearly state it is a third-party tool and may experience temporary issues after site updates.

-   Performance Risk: On very long search results pages, making many concurrent network requests could still impact browser performance.

-   Mitigation: The background script will implement a simple concurrency limit (e.g., no more than 10 fetch requests in flight at any given time) to manage resource usage.

* * * * *

#### 8\. Success Criteria & Testing Plan

-   Functional Success:

-   The extension successfully injects the UI on both search and listing pages.

-   The scoring logic correctly identifies at least 80% of the key criteria in a predefined set of test listings.

-   All interactive elements function as designed in v10.

-   Performance Success:

-   The search results page remains smooth and responsive with no noticeable lag.

-   Cached scores load instantly (<50ms).

-   Uncached scores (using the primary JSON fetch strategy) load for all on-screen listings within 1500ms.

-   Accessibility Success: The extension passes a manual audit for WCAG 2.1 AA compliance, including keyboard navigation and screen reader compatibility.

-   Testing: Manual testing will be conducted on the latest version of Google Chrome on both macOS and Windows, covering desktop and mobile views (via DevTools).

* * * * *

#### 9\. Scoring Algorithm Implementation Roadmap

##### 9.1 Phase 1: Current Implementation (v1.0 - Production Ready)

**Technical Scope**: Ship-ready scoring system using reliably extractable data fields from DOM scraping and JSON endpoints.

**Data Model Fields**:
```javascript
const ListingData = {
  price: 1500,           // From search card or .info-data-price
  size: 60,              // From search card or .info-features spans containing 'm²'
  neighborhood: 'Gràcia', // From search card title parsing
  photoCount: 18,        // From "1/18" counter format
  hasFloorPlan: true,    // From icon detection [data-button-type="plan"]
  fullDescription: '...', // From .comment or search card description
  lastUpdated: '2025-01-01T00:00:00Z' // From .date-update-text
};
```

**Algorithm Implementation** (100-point scale):
1. **Price Anomaly Analysis** (40% weight - 40 points):
   - Calculate €/m² ratio and compare against NEIGHBORHOOD_AVG_PRICES
   - Pass (0 penalty): Within 60-150% of area average
   - Warning (-10 points): 40-60% or 150-200% of average
   - Fail (-25 points): <40% of average (scam indicator)

2. **Listing Quality Assessment** (35% weight - 35 points):
   - Photo scoring: 15+ photos (+15), 8-14 (+10), 4-7 (+5), 1-3 (-5), 0 (-15)
   - Floor plan bonus: +5 points if present
   - Description quality: 200+ chars (+5), 50-199 (0), <50 (-5)

3. **Content Safety Scan** (15% weight - 15 points):
   - Scan description against SCAM_KEYWORDS array
   - Pass (0 penalty): No keywords detected
   - Fail (-15 points): Any scam keywords found

4. **Listing Freshness** (10% weight - 10 points):
   - Fresh (0 penalty): <14 days old
   - Stale (-3 points): 15-30 days
   - Very stale (-7 points): 30+ days

**Risk Level Mapping**:
- 85-100: Low Risk - "Very promising listing with no major red flags"
- 65-84: Medium Risk - "Minor issues to review before proceeding"
- 0-64: High Risk - "Proceed with caution - multiple concerning factors"

##### 9.2 Phase 2: Enhanced Credibility (v2.0 - Future Enhancement)

**Additional Technical Fields**:
```javascript
// Extended ListingData structure
advertiserType: 'agency',     // From .professional-name presence
advertiserName: 'Docta',      // From .about-advertiser-name
contactEmail: 'info@agency.com', // From mailto: links or data attributes
responseRate: 0.85,           // Historical data integration
duplicateDetected: false      // Cross-listing analysis
```

**Rebalanced Algorithm Weights**:
- Price Anomaly: 30% (reduced from 40%)
- Listing Quality: 25% (reduced from 35%)
- Advertiser Credibility: 20% (new major factor)
- Content Safety: 15% (unchanged)
- Freshness & Duplicates: 10% (enhanced with duplicate detection)

**New Advertiser Scoring Logic**:
- Professional agency (+5), Private (0)
- Business email domain (+5), Generic domain (-3)
- Professional naming patterns (+3), Suspicious (-2)
- High response rate (+7), Low response rate (-5)

##### 9.3 Phase 3: Advanced Analytics (v3.0 - Extended Features)

**Advanced Technical Capabilities**:
- Cross-listing duplicate detection via image similarity
- Real-time market trend analysis integration
- Advertiser verification status API integration
- User feedback aggregation system

* * * * *

#### 10\. Future Considerations (Post-MVP)

-   B2B "Listing Optimizer": As noted in our project plan, a future version could be tailored for real estate agencies to help them improve their listing quality.

-   Crowdsourced Data: A V2 could incorporate a feature for users to anonymously report if an agent responded, feeding into a "Responsiveness Score."

Advanced Image Analysis: Integrate a third-party API for reverse image searching to more robustly detect photos stolen from other listings.